var tobserver=function(p,r,h){function m(a,b,d){b||(b=new this.ObserverTree);d||(d="");this.data=a;this.observer=b;this.path=d}function w(a,b){return b?""===a?b:a+"."+b:a}function u(a,b){var d=f.getData(a),c;for(c in d)if(b[c]!==h&&d)b[c](a,d)}function s(a){for(var b="",d=0;d<a.length;d++)b+=(""===b?"":".")+a[d];return b}var x=function(a){return a},t=function(){},y=function(a,b){b(a)},z=function(){var a={'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#47;","<":"&lt;",">":"&gt;"};return function(b){return"string"!==
typeof b?b:b.replace(/[\"&'\/<>]/g,function(d){return a[d]})}}(),v=function(a){for(;-1!==a.indexOf("");)a.splice(a.indexOf(""),1);return a},f;m.prototype.get=function(a){a=(a+"").split(".");if(0===a.length)return this;var b=a[0];if(""===b)return this;if(1===a.length)return new m(this.data===h?h:this.data[b],this.observer,w(this.path,b));a.splice(0,1);return(new m(this.data[b],this.observer,w(this.path,b))).get(s(a))};m.prototype.getData=function(a){a=(a+"").split(".");a=v(a);var b=this.data,d;for(d in a)if(b[a[d]]!==
h&&null!==b[a[d]])b=b[a[d]];else return h;return b};m.prototype.innerSet=function(a,b,d){var c=(a+"").split(".");if(0===c.length)return null;if(1===c.length){if(d)return this.data[a].apply(this.data,b);this.data[a]!==b&&(this.data[a]=b);return this}a=c.pop();return this.get(s(c)).innerSet(a,b,d)};m.prototype.set=function(a,b,d,c,g){d||(d=!1);c===h&&(c=!0);var e=f.getData(a);if(d||e!==b)return this.notify(a,b,d,c,g),this.innerSet(a,b,d)};m.prototype.exec=m.prototype.run=function(a,b){this.set(a,b,
!0)};m.prototype.on=function(a,b){b&&(b="function"==typeof b?{update:b}:b,this.observer.addListener(b,a))};m.prototype.off=function(a,b){this.observer.removeListener(a,b)};m.prototype.notify=function(a,b,d,c,g,e){a===h&&(a="");e===h&&(e=(new Date).getTime()+""+Math.random());a=w(this.path,a);var n=this.notifyee.commands.indexOfIn(a,"path");if(d||b!==f.getData("path")&&(-1===n||!this.notifyee.commands[n].run))this.notifyee.commands.push({path:a,data:b,run:d,online:f.notifyee.onlineMode?c:!1,socket:g}),
clearTimeout(f.notifyee.timeout),f.notifyee.timeout=setTimeout(function(){f.notifyee.notify(e)},f.notifyee.speed)};Array.prototype.indexOfIn=function(a,b){for(var d in this)if(this[d][b]===a)return d;return-1};Object.defineProperty(Array.prototype,"indexOfIn",{enumerable:!1});m.prototype.notifyee={notify:function(a){var b=this.commands;this.commands=[];this.onlineMode=this.onlineLiveMode;for(var d in b)f.observer.runUpdate(b[d].path,a),this.socket&&b[d].online&&!this.isLocal(b[d].path)&&(b[d].socket?
b[d].socket.broadcast.emit("tOmand",JSON.stringify({path:b[d].path,data:b[d].data,run:b[d].run})):this.socket.emit("tOmand",JSON.stringify({path:b[d].path,data:b[d].data,run:b[d].run})));this.onlineMode=!0},onlineMode:!0,onlineLiveMode:!1,commands:[],locals:[],isLocal:function(a){var b=this.locals,d;for(d in b)if(0===a.indexOf(b[d]))return!0;return!1},socket:h,timeout:0,speed:1};m.prototype.ObserverTree=function(){function a(a,d){this.$listener=[];d||(d="");a!==h&&(""===d?this.$listener.push(a):this.addListener(a,
d))}a.prototype.addListener=function(b,d){var c=d.split("."),c=v(c);if(0<c.length){var g="_t_"+c[0];c.shift();this[g]===h?this[g]=new a(b,s(c)):this[g].addListener(b,s(c))}else this.$listener.push(b)};a.prototype.runUpdate=function(a,d){d||(d=(new Date).getTime()+""+Math.random());a||(a="");var c=v(a.split(".")),g;for(g in this.$listener)this.$listener[g].tNotificationRoundNumber!=d&&(this.$listener[g].tNotificationRoundNumber=d,this.$listener[g].update(d,c));if(0<c.length)g="_t_"+c[0],this[g]!==
h&&(c.splice(0,1),this[g].runUpdate(s(c),d));else for(var e in this)0===e.indexOf("_t_")&&this[e].runUpdate("",d)};a.prototype.removeListener=function(a,d){a||(a="");var c=a.split("."),c=v(c),g="_t_"+c[0];if(1<c.length||d&&0<c.length)c.shift(),this[g]!==h&&this[g].removeListener(s(c),d);else if(1===c.length&&this[c[0]]!==h)for(var e in this.$listener)"string"===typeof this.$listener[e].name&&this.$listener[e].name===g&&this.$listener.splice(e,1);else if(d)for(c=0;c<this.$listener.length;c++)this.$listener[c]!==
d&&this.$listener[c].update!==d||this.$listener.splice(c,1)};return a}();m.prototype.StdElementView=function(){function a(d,c){var a=b(d);if(null!==a&&d._tName===h){a.outer=a.outer!==h?a.outer:"div";a.path=""===a.path?"window":a.path;this.element=d;a.defaultValue=[];a.preview=[];for(var e in a.type)"htmllist"===a.type[e].toLowerCase()||"htmloption"===a.type[e].toLowerCase()?(a.defaultValue[e]=d.innerHTML,a.preview[e]=this.element.innerHTML,this.element.innerHTML=""):a.defaultValue[e]=d.getAttribute(a.type),
"value"===a.type[e]&&this.folowElement(d);a.beforeAdd=a.beforeAdd!==h?a.beforeAdd:c.utils.stdViewBehavior.beforeAdd;a.afterAdd=a.afterAdd!==h?a.afterAdd:c.utils.stdViewBehavior.afterAdd;a.beforeRemove=a.beforeRemove!==h?a.beforeRemove:c.utils.stdViewBehavior.beforeRemove;a.afterRemove=a.afterRemove!==h?a.afterRemove:c.utils.stdViewBehavior.afterRemove;a.beforeUpdate=a.beforeUpdate!==h?a.beforeUpdate:c.utils.stdViewBehavior.beforeUpdate;a.afterUpdate=a.afterUpdate!==h?a.afterUpdate:c.utils.stdViewBehavior.afterUpdate;
var f="tObserverName"+1E16*Math.random();this.name=f;this.element._tName=f;this.element._tObserver=this;this.attr=this.element.attr=a;for(e in a.path)c.on(a.path[e],this);this.update()}}function b(a){if(a.attr)return a.attr;var c=a.getAttribute===h?null:a.getAttribute("tObserver");if(null===c)return null;try{c=eval("({"+c+"})")}catch(b){try{c=eval("("+c+")")}catch(e){c={path:eval('"'+c+'"')}}}c.path||(c.path=[""]);Array.isArray(c.path)||(c.path=[c.path]);for(var f in c.path)c.path[f]="."==c.path[f][c.path[f].length-
1]?c.path[f].slice(0,c.path[f].length-1):c.path[f],c.path[f]=""===c.path[f]?"":c.path[f];c.type=c.type?c.type:"innerhtml";Array.isArray(c.type)||(c.type=[c.type]);Array.isArray(c.filter)||(c.filter=[c.filter]);return a.attr=c}a.prototype.update=function(){var a,c=x,b=this.attr.path.length;b<this.attr.type.length&&(b=this.attr.type.length);for(var e=0;e<b;e++){var n=this.attr.path[e]===h?n:this.attr.path[e];a=this.attr.type[e]?this.attr.type[e]:a;var c="value"===a||"data"===a?x:z,k=f.getData(n),l=
k="number"===typeof k?k+"":k,c=this.attr.filter[e]?this.attr.filter[e]:c,k=c(k),k=k!==h?k:this.attr.defaultValue;a=this.attr.type[e]?this.attr.type[e]:a;switch(a){case "innerhtml":case "innerHtml":case "innerHTML":case h:this.attr.beforeUpdate(this.element,function(a){a.innerHTML!=k&&(a.innerHTML=k,a.attr.afterUpdate(a));a.attr.afterUpdate(a)});break;case "data":this.element.data=k;break;case "htmllist":case "htmlList":this.updateList(k,l);break;case "htmloption":case "htmlOption":this.updateOption(k,
l);break;case "value":this.attr.beforeUpdate(this.element,function(a){a.value!=k&&(a.value=k,a.attr.afterUpdate(a))});break;default:this.attr.beforeUpdate(this.element,function(c){if(!c.style[a]===h||"src"==a){if(c.getAttribute(a)==k)return;c.setAttribute(a,k)}else{if(c.style[a]==k)return;c.style[a]=k}c.attr.afterUpdate(c)})}}};a.prototype.updateOption=function(a,c){if(!1===a)this.element.innerHTML="",this.element.display="none";else if(this.element.display="",""===this.element.innerHTML){var b=r.createElement("div");
b.innerHTML=this.attr.preview;for(this.findAndUpdatePath(b,this.attr.path);b.children[0]!==h;)this.attr.beforeAdd(b.children[0],c),this.element.appendChild(b.children[0]),this.attr.afterAdd(b.children[0],c)}};a.prototype.updateList=function(a,c){this.displayedOrdData!=c&&(this.element.innerHTML="");var b=0;this.displayedOrdData=c;for(var e=this.element.children,n=[],k=[],b=0;b<e.length;b++){var l=a.indexOf(e[b].item);-1==l?(e[b].innerHTML=e[b].innerHTML.replace("tobserver","removedtObserver").trim(),
this.attr.beforeRemove(e[b],function(a){a&&(a.remove(),b--)})):(this.attr.beforeUpdate(e[b],t),n.push(e[b].item),"tobserverlistitem"==e[b].className&&(l!=e[b].position&&this.updateRootPath(e[b],this.attr.path+"."+l,this.attr.path+"."+e[b].position),e[b].position=l,k.push(e[b])))}e=r.activeElement;k.sort(function(a,b){return a.position-b.position});for(b=0;b<k.length;b++)this.element.appendChild(k[b]);e.focus();e=0;if(c){for(b=0;b<a.length;b++)if(k[e]!==h&&a[b]==k[e].item)e++;else if(-1==n.indexOf(a[b])){var l=
c.indexOf(a[b]),q=r.createElement(this.attr.outer);q.setAttribute("class","tobserverlistitem");q.innerHTML=this.attr.preview;this.findAndUpdatePath(q,this.attr.path+"."+l);q.position=b;q.item=a[b];k[e]!==h?k[e].parentNode.insertBefore(q,k[e]):this.element.appendChild(q);f.StdElementView.findTObserver(q);this.attr.beforeAdd(q,a[b]);this.attr.afterAdd(q,a[b])}e=this.element.children}};a.prototype.findAndUpdatePath=function(a,c){var g=b(a),e=a.children;if(null===g)for(var f in e)this.findAndUpdatePath(e[f],
c);else this.setRoot(a,c)};a.prototype.setRoot=function(a,c){var g=b(a);g.path||(g.path=[""]);for(var e in g.path)-1==g.path[e].indexOf(c)&&(g.path[e]=c+"."+g.path[e])};a.prototype.updateRootPath=function(a,b,g){if(a&&b&&g){a=a.children;for(var e in a)if(a[e].attr)for(var h in a[e].attr.path){var k=a[e].attr.path[h].replace(g+".","");"htmllist"==a[e].attr.type[h].toLowerCase()&&this.updateRootPath(a[e],k+"."+k,g+"."+k);f.off(a[e].attr.path[h]+"."+a[e]._tName);f.on(b+"."+k,a[e]._tObserver);a[e].attr.path[h]=
b+"."+k}else this.updateRootPath(a[e],b,g)}};a.prototype.folowElement=function(a){var b=function(){var b=a.attr,c;for(c in b.path)if("value"===b.type[c]){var h=a.value,k=a.getAttribute("type");null!==k&&"number"===k.toLocaleLowerCase().trim()&&(h=parseFloat(h));null!==k&&"checkbox"===k.toLocaleLowerCase().trim()&&(h=a.checked);f.set(b.path[c],h)}};a.addEventListener("change",b);a.addEventListener("keyup",b)};a.initDomViews=function(){var d=r.getElementsByTagName("html")[0];f.utils.bindEvent(d,"DOMNodeInserted",
function(b){a.findTObserver(b.srcElement?b.srcElement:b.target)});f.utils.bindEvent(d,"DOMNodeRemoved",function(a){var d=a.srcElement?a.srcElement:a.target;d!==h&&d.getAttribute!==h&&setTimeout(function(){var a=b(d);a!==h&&d._tName!==h&&(a=a.path,a=a!==h?a:"",f.off(a+"."+d._tName))},1E3)});this.findTObserver()};a.findTObserver=function(d){d===h&&(d=r.getElementsByTagName("html")[0]);var c=b(d),g=d.children;if(null===c)for(var e in g)a.findTObserver(g[e]);else d.attr=c,new f.StdElementView(d,f)};return a}();
m.prototype.utils={stdViewBehavior:{beforeAdd:t,afterAdd:t,beforeRemove:y,afterRemove:t,beforeUpdate:y,afterUpdate:t},linkViews:function(a,b){f.on(a,new this.LinkView(b));f.on(b,new this.LinkView(a))},linkToArrayViews:function(a,b){f.on(a,new this.LinkToArrayView(a,b));f.on(b,new this.LinkFromArrayView(a,b))},LinkView:function(a){this.update=function(b){var d=f.getData(a);f.notify(a,d,!1,!0,h,b)}},LinkToArrayView:function(a,b){this.update=function(d){var c=f.getData(a),g=f.getData(b),c=b+"."+g.indexOf(c),
g=f.getData(c);f.notify(c,g,!1,!0,h,d)}},LinkFromArrayView:function(a,b){this.update=function(d,c){var g=f.getData(a),e=f.getData(b),n=e.indexOf(g);c[0]!==h&&n==c[0]&&e[c[0]]!==g&&f.notify(a,g,!1,!0,h,d)}},ArrayUpdateView:function(a,b){this.update=function(d,c){if(c[0]!==h&&c[1]!==h){var g=c.splice(0,1),e=c.splice(0,1),n=f.getData(a+"."+g);if(n&&b[e])b[e](a+"."+g,n,c)}else for(g=f.getData(a),e=0;e<g.length;e++)u(a+"."+e,b)}},registerArrayUpdateView:function(a,b){f.on(a,new f.utils.ArrayUpdateView(a,
b));for(var d=f.getData(a),c=0;c<d.length;c++)u(a+"."+c,b)},ObjectUpdateView:function(a,b){this.update=function(d,c){if(c[0]!==h){var g=c.splice(0,1),e=f.getData(a);if(e)b[g](a,e,c)}else u(a,b)}},registerObjectUpdateView:function(a,b){f.on(a,new f.utils.ObjectUpdateView(a,b));u(a,b)},history:function(){var a={},b=function(){},d={},c=Array.prototype.slice,g=Array.prototype.some,e=Array.prototype.forEach,n=Function.prototype.bind;a.bind=function(d,e){var f;if(n&&d.bind===n)return n.apply(d,c.call(arguments,
1));if(!a.isFunction(d))throw new TypeError;f=c.call(arguments,2);return function(){if(!(this instanceof void 0))return d.apply(e,f.concat(c.call(arguments)));b.prototype=d.prototype;var a=new b;b.prototype=null;var g=d.apply(a,f.concat(c.call(arguments)));return Object(g)===g?g:a}};a.bindAll=function(b){var d=c.call(arguments,1);if(0===d.length)throw Error("bindAll must be passed function names");k(d,function(c){b[c]=a.bind(b[c],b)});return b};var k=a.each=a.forEach=function(b,c,f){if(null==b)return b;
var g,h;if(e&&b.forEach===e)b.forEach(c,f);else if(b.length===+b.length)for(g=0,h=b.length;g<h;g++){if(c.call(f,b[g],g,b)===d)return}else{var k=a.keys(b);g=0;for(h=k.length;g<h;g++)if(c.call(f,b[k[g]],k[g],b)===d)return}return b};a.identity=function(a){return a};a.some=a.any=function(a,b,c){var e=!1;if(null==a)return e;if(g&&a.some===g)return a.some(b,c);k(a,function(a,g,f){if(e||(e=b.call(c,a,g,f)))return d});return!!e};var l=function(){a.bindAll(this,"checkUrl");p!==h&&(this.location=p.location,
this.history=p.history)},q=/^[#\/]|\s+$/g,m=/^\/+|\/+$/g,A=/msie [\w.]+/,s=/\/$/,t=/#.*$/;l.started=!1;l.prototype.interval=50;l.prototype.atRoot=function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root};l.prototype.getHash=function(a){return(a=(a||this).location.href.match(/#(.*)$/))?a[1]:""};l.prototype.getFragment=function(a,b){if(null==a)if(this._hasPushState||!this._wantsHashChange||b){a=decodeURI(this.location.pathname+this.location.search);var c=this.root.replace(s,"");
a.indexOf(c)||(a=a.slice(c.length))}else a=this.getHash();return a.replace(q,"")};l.prototype.start=function(a){if(l.started)throw Error("history has already been started");l.started=!0;this.options=a===h?{}:a;this.options.root="/";this.path=this.options.path===h?"url":this.options.path;this.root=this.options.root;this._wantsHashChange=!1!==this.options.hashChange;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);a=this.getFragment();
var b=r.documentMode,b=A.exec(navigator.userAgent.toLowerCase())&&(!b||7>=b);this.root=("/"+this.root+"/").replace(m,"/");b&&this._wantsHashChange&&(this.iframe=$('<iframe src="javascript:0" tabindex="-1">').hide().appendTo("body")[0].contentWindow,this.navigate(a));if(this._hasPushState)$(p).on("popstate",this.checkUrl);else if(this._wantsHashChange&&"onhashchange"in p&&!b)$(p).on("hashchange",this.checkUrl);else this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval));
this.fragment=a;a=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot())return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+"#"+this.fragment),!0;this._hasPushState&&this.atRoot()&&a.hash&&(this.fragment=this.getHash().replace(q,""),this.history.replaceState({},r.title,this.root+this.fragment))}$(r).on("click","a[href^='/']",function(a){var b=$(a.currentTarget).attr("href");if(!(0<=b.indexOf("sign_out")||a.altKey||a.ctrlKey||
a.metaKey||a.shiftKey))return a.preventDefault(),a=b.replace(/^\//,"").replace("#!/",""),f.utils.history.navigate(a,{trigger:!0}),!1});f.on(this.path,function(){var a=f.getData(f.utils.history.path);f.utils.router.route(a)});if(!this.options.silent)return this.loadUrl()};l.prototype.stop=function(){$(p).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);this._checkUrlInterval&&clearInterval(this._checkUrlInterval);l.started=!1};l.prototype.route=function(a,b){this.handlers.unshift({route:a,
callback:b})};l.prototype.checkUrl=function(){var a=this.getFragment();a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe)));if(a===this.fragment)return!1;this.navigate(a);this.iframe&&this.navigate(a);this.loadUrl()};l.prototype.loadUrl=function(a){a=this.fragment=this.getFragment(a);f.set(this.path,a)};l.prototype.navigate=function(a,b){if(!l.started)return!1;b&&!0!==b||(b={trigger:!!b});var c=this.root+(a=this.getFragment(a||""));a=a.replace(t,"");if(this.fragment!==a){this.fragment=
a;""===a&&"/"!==c&&(c=c.slice(0,-1));if(this._hasPushState)this.history[b.replace?"replaceState":"pushState"]({},r.title,c);else if(this._wantsHashChange)this._updateHash(this.location,a,b.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,b.replace));else return this.location.assign(c);if(b.trigger)return this.loadUrl(a)}};l.prototype._updateHash=function(a,b,c){c?(c=a.href.replace(/(javascript:|#).*$/,
""),a.replace(c+"#"+b)):a.hash="#"+b};return new l}(),router:function(a){function b(){this.events=[];this.params=[]}b.prototype.version="0.4.2";b.prototype.route=function(a){var b=Array.prototype.slice.call(arguments,1);this.events.forEach(function(a){a.apply(this,b)});return this};b.regexRoute=function(a,b,g,e){if(a instanceof RegExp)return a;a instanceof Array&&(a="("+a.join("|")+")");a=a.concat(e?"":"/?").replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,
function(a,d,e,g,f,h){b.push({name:g,optional:!!h});d=d||"";return""+(h?"":d)+"(?:"+(h?d:"")+(e||"")+(f||e&&"([^/.]+?)"||"([^/]+?)")+")"+(h||"")}).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)");return new RegExp("^"+a+"$",g?"":"i")};b.prototype.on=b.prototype.add=b.prototype.get=function(a,c){var g=this,e=[],f=b.regexRoute(a,e);this.events.push(function(b){var l=p.url.match(f);if(l){b={route:a,value:b,handler:c,params:g.params,regex:l,propagateEvent:!0,preventDefault:function(){this.propagateEvent=
!1}};var m={params:{},keys:e,matches:b.regex.slice(1)};m.matches.forEach(function(a,b){m.params[e[b]&&e[b].name?e[b].name:b]=a?decodeURIComponent(a):h});c.call(g,m,b)}return g});return this};return new b}.call({},p),bindEvent:function(a,b,d){a.addEventListener?a.addEventListener(b,d,!1):a.attachEvent&&a.attachEvent("on"+b,d)},setSocket:function(a){f.notifyee.socket=a;a.on("tOmand",function(a){try{var d=JSON.parse(a);f.notifyee.isLocal(d.path)||f.set(d.path,d.data,d.run,!1)}catch(c){}})},jQuerySocket:function(a){this.emit=
function(b,d){$.post(a,{name:b,data:d})}}};return f=new m(p)}("object"===typeof window?window:{},"object"===typeof document?document:{});"object"===typeof module?module.exports=tobserver:window instanceof Window&&tobserver.utils.bindEvent(window,"load",function(){var p=document.createElement("style");p.innerHTML=".tobserverlistitem{margin:0px;\tpadding:0px;}";document.getElementsByTagName("head")[0].appendChild(p);tobserver.StdElementView.initDomViews()});